<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hamiltonhuaji.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"style":null,"show_result":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="这是《如何编写OptiFine光影包》系列正文的第一篇. 本篇教程将搭建光影包编写的基本框架, 以接管 OptiFine&#x2F;minecraft 自带的那些着色器, 将延迟着色真正地执行起来.">
<meta property="og:type" content="article">
<meta property="og:title" content="如何编写OptiFine光影包(1)">
<meta property="og:url" content="https://hamiltonhuaji.github.io/2022/03/14/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99OptiFine%E5%85%89%E5%BD%B1%E5%8C%85-1/index.html">
<meta property="og:site_name" content="Ad Astra per Aspera">
<meta property="og:description" content="这是《如何编写OptiFine光影包》系列正文的第一篇. 本篇教程将搭建光影包编写的基本框架, 以接管 OptiFine&#x2F;minecraft 自带的那些着色器, 将延迟着色真正地执行起来.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hamiltonhuaji.github.io/2022/03/14/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99OptiFine%E5%85%89%E5%BD%B1%E5%8C%85-1/artifacts.png">
<meta property="article:published_time" content="2022-03-14T08:32:47.000Z">
<meta property="article:modified_time" content="2023-11-30T15:47:17.291Z">
<meta property="article:author" content="HamiltonHuaji">
<meta property="article:tag" content="Computer Graphics">
<meta property="article:tag" content="Shaderpack">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hamiltonhuaji.github.io/2022/03/14/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99OptiFine%E5%85%89%E5%BD%B1%E5%8C%85-1/artifacts.png">


<link rel="canonical" href="https://hamiltonhuaji.github.io/2022/03/14/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99OptiFine%E5%85%89%E5%BD%B1%E5%8C%85-1/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hamiltonhuaji.github.io/2022/03/14/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99OptiFine%E5%85%89%E5%BD%B1%E5%8C%85-1/","path":"2022/03/14/如何编写OptiFine光影包-1/","title":"如何编写OptiFine光影包(1)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>如何编写OptiFine光影包(1) | Ad Astra per Aspera</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Ad Astra per Aspera</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">HamiltonHuaji</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://blog.lockon.ml/" title="https:&#x2F;&#x2F;blog.lockon.ml&#x2F;" rel="noopener" target="_blank">Andy Lee</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://zhangshuqiao.org/" title="https:&#x2F;&#x2F;zhangshuqiao.org&#x2F;" rel="noopener" target="_blank">Galaxy Mimi</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://blog.yixuan-wang.site/" title="https:&#x2F;&#x2F;blog.yixuan-wang.site&#x2F;" rel="noopener" target="_blank">Tom Wang</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://blog.bicpotato.net/" title="https:&#x2F;&#x2F;blog.bicpotato.net" rel="noopener" target="_blank">一个只会摸鱼的大学生罢了[RIP]</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hamiltonhuaji.github.io/2022/03/14/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99OptiFine%E5%85%89%E5%BD%B1%E5%8C%85-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HamiltonHuaji">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ad Astra per Aspera">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="如何编写OptiFine光影包(1) | Ad Astra per Aspera">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          如何编写OptiFine光影包(1)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-14 16:32:47" itemprop="dateCreated datePublished" datetime="2022-03-14T16:32:47+08:00">2022-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-11-30 23:47:17" itemprop="dateModified" datetime="2023-11-30T23:47:17+08:00">2023-11-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>这是《如何编写OptiFine光影包》系列正文的第一篇. 本篇教程将搭建光影包编写的基本框架, 以接管 OptiFine/minecraft 自带的那些着色器, 将延迟着色真正地执行起来.</p>
<span id="more"></span>
<p>作为教学性质的光影包, 笔者期望能在教程结束时实现以下特性和指标:</p>
<ol type="1">
<li>光线追踪每帧样本量 1~4 spp</li>
<li>使用 SVGF 降噪</li>
<li>能处理透明物体的反射, 但出于简化的考虑, 假定所有折射率都是 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></svg></mjx-container></span>; 递归的反射也不会被考虑</li>
<li>实体受光照影响, 但不遮挡除太阳和月亮外的光源的光照, 来自实体的反射光也不会照亮其它物体</li>
<li>不使用泛光等光污染后处理特效</li>
<li>仅处理 <code>LD*E</code> 和 <code>LD*SE</code> 的路径<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="路径表示法见[光传输](https://hbbalfred.github.io/2015/11/20/light-transport.html), 即用 `L` 表示光源, `D` 表示漫反射面, `S` 表示光泽反射面, `E` 表示眼睛.
">[1]</span></a></sup></li>
</ol>
<p>尽管更高的光线追踪性能是可以期望的, 但降噪算法也具有不小的消耗(SVGF 所使用的滤波器大小是 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="5.028ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 2222.4 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></g><g data-mml-node="mo" transform="translate(722.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mn" transform="translate(1722.4,0)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></g></g></g></svg></mjx-container></span> 的, 且要在不同的尺度上执行 5 次), 因此指标(1)的 1~4 spp 是较为合理的结果. 特性(3)是为了 TAA 方便而设置的, 这使得透明物体的透射能较为简单地执行时间重投影, 否则就需要考虑 <a target="_blank" rel="noopener" href="https://sites.cs.ucsb.edu/~lingqi/publications/paper_trmv.pdf">Temporally Reliable Motion Vectors for Real-time Ray Tracing</a> 的方法, 何况 SEUS PTGI 也是这么干的(逃. 特性(4)使得光线追踪的求交完全不用考虑非方块形状的实体, 大大简化了求交算法, 而太阳/月亮的直接光照可以较方便地利用阴影映射处理. 特性(6)是我们能处理的较简单情况, 然而这使得我们无法计算<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Caustic_(optics)">焦散</a>等效果而只能做一些看起来比较像焦散的特效, 但 SEUS PTGI 也是这么干的×2... 何况焦散这样的效果本来就需要光子映射这样的技术去计算.</p>
<figure>
<img src="artifacts.png" alt=""><figcaption>minecraft RTX 的折射. 即使是 Nvidia, 也难以将复杂的反射和折射处理得完美无瑕</figcaption>
</figure>
<p>回顾<a href="https://hamiltonhuaji.github.io/2022/03/05/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99OptiFine%E5%85%89%E5%BD%B1%E5%8C%85-%E5%B7%A5%E5%85%B7%E7%AF%87/">原理篇</a>中的光影包目录结构, 笔者创建了下列目录树: <div class="spoiler collapsed">
                    <div class="spoiler-title">HowToOptiFine/commit/a2208932f54e50cb434cf52aa9467312b2f7f054</div>
                    <div class="spoiler-content"><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── makefile</span><br><span class="line">├── src</span><br><span class="line">│   ├── block.properties</span><br><span class="line">│   ├── composite.fsh</span><br><span class="line">│   ├── composite15.fsh</span><br><span class="line">│   ├── composite2.fsh</span><br><span class="line">│   ├── core</span><br><span class="line">│   │   ├── gbuffers</span><br><span class="line">│   │   │   ├── gbuffers_discard.frag</span><br><span class="line">│   │   │   ├── gbuffers_discard.vert</span><br><span class="line">│   │   │   ├── gbuffers_main.frag</span><br><span class="line">│   │   │   └── gbuffers_main.vert</span><br><span class="line">│   │   ├── shadow</span><br><span class="line">│   │   └── svgf</span><br><span class="line">│   │       ├── flush_history_buffers.hpp</span><br><span class="line">│   │       └── temporal_accumulation.hpp</span><br><span class="line">│   ├── inc</span><br><span class="line">│   │   ├── blockmapping.hpp</span><br><span class="line">│   │   ├── buffers.hpp</span><br><span class="line">│   │   ├── constants.hpp</span><br><span class="line">│   │   ├── gbuffer.hpp</span><br><span class="line">│   │   ├── glsl.hpp</span><br><span class="line">│   │   ├── random.hpp</span><br><span class="line">│   │   ├── uniforms.hpp</span><br><span class="line">│   │   └── utils.hpp</span><br><span class="line">│   ├── lang</span><br><span class="line">│   │   └── zh_CN.lang</span><br><span class="line">│   └── shaders.properties</span><br><span class="line">└── tools</span><br><span class="line">    ├── blocks.txt</span><br><span class="line">    ├── build.py</span><br><span class="line">    ├── genblocks.py</span><br><span class="line">    ├── patch.py</span><br><span class="line">    └── validate.sh</span><br><span class="line"></span><br><span class="line">8 directories, 26 files</span><br></pre></td></tr></table></figure>
</div>
                </div></p>
<p>通过 <code>tools</code> 目录里的各种工具, 可以生成最终的 <code>shaders/</code> 目录. 乍一看, 有各式各样的 <code>gbuffers_*.*sh</code> 着色器需要编写, 非常可畏, 然而 <code>gbuffers_*.*sh</code> 可以大致分为 3 类, 即绘制透明物体的着色器①, 绘制不透明的普通物体的着色器②和绘制特效或云/日月等不受光照影响的物体的着色器③, 每类着色器的代码都是可以共用的.</p>
<p>对于③, 在教程的本阶段, 简单地丢弃它们的像素即可: <div class="spoiler collapsed">
                    <div class="spoiler-title">HowToOptiFine/blob/a2208932f54e50cb434cf52aa9467312b2f7f054/src/core/gbuffers/gbuffers_discard.vert</div>
                    <div class="spoiler-content"><figure class="highlight cpp">
<table>
<tr>
<td class="gutter">
<pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
</td>
<td class="code">
<pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/glsl.hpp"</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    gl_Position = <span class="built_in">vec4</span>(<span class="number">-1.</span>);</span><br><span class="line">}</span><br></pre>
</td>
</tr>
</table>
</figure>
</div>
                </div> <div class="spoiler collapsed">
                    <div class="spoiler-title">HowToOptiFine/blob/a2208932f54e50cb434cf52aa9467312b2f7f054/src/core/gbuffers/gbuffers_discard.frag</div>
                    <div class="spoiler-content"><figure class="highlight cpp">
<table>
<tr>
<td class="gutter">
<pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
</td>
<td class="code">
<pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/glsl.hpp"</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    discard;</span><br><span class="line">}</span><br></pre>
</td>
</tr>
</table>
</figure>
</div>
                </div> 透明物体(如水面, 玻璃)的处理较为复杂, 和实体一起暂时归到这一类中.</p>
<p>工具篇提供的预处理工具会保证带有 <code>#pragma once</code> 指令的文件只被包含一次, 可以起到<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Include_guard">保护宏</a>的作用. <code>inc/glsl.hpp</code> 是工具篇中用于将 glsl 伪装成 C++ 的头文件.</p>
<p>对于②, 我们需要绘制一张 G-buffer, 并在 composite 阶段完成着色: <div class="spoiler collapsed">
                    <div class="spoiler-title">HowToOptiFine/blob/a2208932f54e50cb434cf52aa9467312b2f7f054/src/core/gbuffers/gbuffers_main.vert</div>
                    <div class="spoiler-content"><figure class="highlight cpp">
<table>
<tr>
<td class="gutter">
<pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>
</td>
<td class="code">
<pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/glsl.hpp"</span></span></span><br><span class="line"></span><br><span class="line">attribute vec4 at_tangent;</span><br><span class="line">attribute vec3 mc_Entity;</span><br><span class="line">attribute vec2 mc_midTexCoord;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/constants.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/uniforms.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/utils.hpp"</span></span></span><br><span class="line"></span><br><span class="line">flat out uint blockID;      <span class="comment">// 方块种类</span></span><br><span class="line">out vec2      texCoord;     <span class="comment">// 纹理坐标</span></span><br><span class="line">out vec3      color;        <span class="comment">// 顶点色</span></span><br><span class="line">out vec3      normal;       <span class="comment">// 面法线(世界坐标)</span></span><br><span class="line">out vec3      tangent;      <span class="comment">// 面切线(世界坐标)</span></span><br><span class="line">out vec3      worldPos;     <span class="comment">// 世界坐标</span></span><br><span class="line">out vec3      motionVector; <span class="comment">// 运动向量</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    blockID     = <span class="built_in">getBlockID</span>(mc_Entity);</span><br><span class="line">    texCoord    = gl_MultiTexCoord0.st;</span><br><span class="line">    color       = gl_Color.rgb;</span><br><span class="line">    normal      = <span class="built_in">normalize</span>(<span class="built_in">mat3</span>(gbufferModelViewInverse) * gl_NormalMatrix * gl_Normal);</span><br><span class="line">    tangent     = at_tangent.xyz;</span><br><span class="line">    worldPos    = (gbufferModelViewInverse * gl_ModelViewMatrix * gl_Vertex).xyz + cameraPosition.xyz;</span><br><span class="line">    gl_Position = gbufferProjection * gl_ModelViewMatrix * gl_Vertex;</span><br><span class="line">}</span><br></pre>
</td>
</tr>
</table>
</figure>
</div>
                </div> <div class="spoiler collapsed">
                    <div class="spoiler-title">HowToOptiFine/blob/a2208932f54e50cb434cf52aa9467312b2f7f054/src/core/gbuffers/gbuffers_main.frag</div>
                    <div class="spoiler-content"><figure class="highlight cpp">
<table>
<tr>
<td class="gutter">
<pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre>
</td>
<td class="code">
<pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/glsl.hpp"</span></span></span><br><span class="line"></span><br><span class="line">uniform sampler2D tex;</span><br><span class="line">uniform sampler2D specular;</span><br><span class="line"></span><br><span class="line">flat in uint blockID;      <span class="comment">// 方块种类</span></span><br><span class="line">in vec2      texCoord;     <span class="comment">// 纹理坐标</span></span><br><span class="line">in vec3      color;        <span class="comment">// 顶点色</span></span><br><span class="line">in vec3      normal;       <span class="comment">// 面法线(世界坐标)</span></span><br><span class="line">in vec3      tangent;      <span class="comment">// 面切线(世界坐标)</span></span><br><span class="line">in vec3      worldPos;     <span class="comment">// 世界坐标</span></span><br><span class="line">in vec3      motionVector; <span class="comment">// 运动向量</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/blockmapping.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/gbuffer.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/uniforms.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/utils.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> rendertargets(0, 1, 4)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    GBufferData gd;</span><br><span class="line"></span><br><span class="line">    vec4 diffuse = <span class="built_in">sRGB2linear</span>(<span class="built_in">texture</span>(tex, texCoord) * <span class="built_in">vec4</span>(color, <span class="number">1.f</span>));</span><br><span class="line">    <span class="keyword">if</span> (diffuse.a &lt; <span class="number">.0125</span>) { discard; } <span class="comment">// 丢弃树叶等材质的镂空部分</span></span><br><span class="line"></span><br><span class="line">    vec3 spec     = <span class="built_in">texture</span>(specular, texCoord).rgb; <span class="comment">// b for emissive</span></span><br><span class="line">    gd.blockID    = blockID;</span><br><span class="line">    gd.diffuse    = diffuse.rgb;</span><br><span class="line">    gd.normal     = normal;</span><br><span class="line">    gd.smoothness = spec.r;</span><br><span class="line">    gd.metalness  = spec.g;</span><br><span class="line">    gd.tangent    = tangent;</span><br><span class="line">    <span class="built_in">packGBufferData</span>(gd);</span><br><span class="line">    gl_FragData[<span class="number">0</span>] = gd.rawData;</span><br><span class="line">    gl_FragData[<span class="number">1</span>] = <span class="built_in">vec4</span>(worldPos, <span class="number">1.f</span>);</span><br><span class="line"></span><br><span class="line">    vec4 projPosPrev = gbufferPreviousProjection * gbufferPreviousModelView * <span class="built_in">vec4</span>(worldPos - previousCameraPosition, <span class="number">1.f</span>);</span><br><span class="line">    projPosPrev.xyz /= projPosPrev.w;</span><br><span class="line"></span><br><span class="line">    vec3 curr = gl_FragCoord.xyz / <span class="built_in">vec3</span>(viewWidth, viewHeight, <span class="number">1.f</span>);</span><br><span class="line">    curr *= <span class="number">2.f</span>;</span><br><span class="line">    curr -= <span class="number">1.f</span>;</span><br><span class="line">    gl_FragData[<span class="number">2</span>] = <span class="built_in">vec4</span>(projPosPrev.xyz - curr, <span class="number">0.f</span>);</span><br><span class="line">}</span><br></pre>
</td>
</tr>
</table>
</figure>
</div>
                </div></p>
<p>G-buffer 的定义如下 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">GBufferData</span> {</span><br><span class="line">    vec4 rawData;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (3 + 1) * 8 位精度, 丢弃 diffuse.a, 放入 blockID 的高 8 位</span></span><br><span class="line">    vec3 diffuse;</span><br><span class="line">    uint _blockIDHigh8;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (3 + 1) * 8 位精度</span></span><br><span class="line">    vec3  normal;</span><br><span class="line">    <span class="type">float</span> smoothness;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (3 + 1) * 8 位精度</span></span><br><span class="line">    vec3  tangent;</span><br><span class="line">    <span class="type">float</span> metalness;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// blockID 的低 8 位</span></span><br><span class="line">    uint _blockIDLow8;</span><br><span class="line"></span><br><span class="line">    uint blockID;</span><br><span class="line">};</span><br></pre></td></tr></table></figure></p>
<p>其打包的数据有:</p>
<ul>
<li><code>vec3 diffuse</code>, 为漫反射颜色</li>
<li><code>vec3 normal</code>, 世界坐标下的法线</li>
<li><code>vec3 tangent</code>, 世界坐标下的切线</li>
<li><code>float smoothness</code>, 光滑度</li>
<li><code>float metalness</code>, 金属度</li>
<li><code>int blockID</code>, 16 bits 的方块 ID, 低 5 位表示方块形状, 第 6 位表示是否发光, 第 7 位表示是否透明, 高 8 位编码方块的各种数据值</li>
</ul>
<p>最终 G-buffer 将被打包进 RGBA32F 格式(即有 RGBA 共 4 个通道, 每个通道都是 32 bits 的 float)的 <code>colortex0</code>.</p>
<p>世界坐标将被写入同样是 RGBA32F 的 <code>colortex1</code>, 浪费了一个 w 分量, 日后不够用了再来优化.</p>
<p><code>colortex4</code> 则是运动向量(motion vector), 此处我们学习 UE4 的做法, 在 G-buffer 阶段分别使用本帧和上帧的 MVP 矩阵, 计算好裁切坐标系中的坐标并作差, 得到运动向量(其 xy 分量是屏幕 uv 的变化量, z 分量是深度值的变化量). 在教程的本阶段就准备好运动向量的原因是希望较早地完成 TAA 的调试. 当然, 此处又有待填的坑, 即日后加入实体的渲染时, 还需要考虑实体的运动.</p>
<p>我们计划在 <code>composite.fsh</code> 中完成蒙特卡洛光线追踪, 而目前只是将 G-buffer 的 diffuse 部分加上噪声填到 <code>colortex6</code> 中, 以使 TAA 的调试能进行. <div class="spoiler collapsed">
                    <div class="spoiler-title">HowToOptiFine/blob/a2208932f54e50cb434cf52aa9467312b2f7f054/src/composite.fsh</div>
                    <div class="spoiler-content"><figure class="highlight cpp">
<table>
<tr>
<td class="gutter">
<pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
</td>
<td class="code">
<pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/gbuffer.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/glsl.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/uniforms.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/blockmapping.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/buffers.hpp"</span></span></span><br><span class="line">vec2  texCoord = gl_FragCoord.xy / viewSize;</span><br><span class="line">ivec2 texelPos = <span class="built_in">ivec2</span>(gl_FragCoord.xy);</span><br><span class="line"></span><br><span class="line">uniform sampler2D tex_gbuffer;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"inc/random.hpp"</span></span></span><br><span class="line"><span class="function">vec3 <span class="title">random3d</span><span class="params">(uvec3 seed)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">vec3</span>(<span class="built_in">pcg3d</span>(seed)) * (<span class="number">1.f</span> / <span class="built_in">float</span>(<span class="number">0xffffffff</span>u));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> rendertargets(6, 7)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    GBufferData gd;</span><br><span class="line">    gd.rawData = <span class="built_in">texelFetch</span>(tex_gbuffer, texelPos, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">unpackGBufferData</span>(gd);</span><br><span class="line">    gl_FragData[<span class="number">0</span>].rgb = gd.diffuse + (<span class="built_in">random3d</span>(<span class="built_in">uvec3</span>(texelPos, frameCounter)) - <span class="number">.5</span>f) / <span class="number">2.f</span>;</span><br><span class="line">    gl_FragData[<span class="number">1</span>].rg  = <span class="built_in">vec2</span>(gd.smoothness, gd.metalness);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if (isCube(gd.blockID) &amp;&amp; !isEmissive(gd.blockID)) { discard; }</span></span><br><span class="line">    <span class="comment">// if (isFence(gd.blockID) &amp;&amp; (isWest(gd.blockID) || isNorth(gd.blockID))) { discard; }</span></span><br><span class="line">    <span class="comment">// if (isWallTorch(gd.blockID) &amp;&amp; getFacing(gd.blockID)==facing_north) { discard; }</span></span><br><span class="line">}</span><br><span class="line"></span><br></pre>
</td>
</tr>
</table>
</figure>
</div>
                </div></p>
<p>// To be continued...</p>
<div id="footnotes">
<hr>
<div id="footnotelist">
<ol style="list-style: none; padding-left: 0; margin-left: 40px">
<li id="fn:1">
<span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">路径表示法见<a target="_blank" rel="noopener" href="https://hbbalfred.github.io/2015/11/20/light-transport.html">光传输</a>, 即用 <code>L</code> 表示光源, <code>D</code> 表示漫反射面, <code>S</code> 表示光泽反射面, <code>E</code> 表示眼睛.<a href="#fnref:1" rev="footnote"> ↩︎</a></span>
</li>
</ol>
</div>
</div>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>HamiltonHuaji
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://hamiltonhuaji.github.io/2022/03/14/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99OptiFine%E5%85%89%E5%BD%B1%E5%8C%85-1/" title="如何编写OptiFine光影包(1)">https://hamiltonhuaji.github.io/2022/03/14/如何编写OptiFine光影包-1/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均保留所有权利。转载请联系作者以获得许可！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Computer-Graphics/" rel="tag"># Computer Graphics</a>
              <a href="/tags/Shaderpack/" rel="tag"># Shaderpack</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/03/05/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99OptiFine%E5%85%89%E5%BD%B1%E5%8C%85-%E5%B7%A5%E5%85%B7%E7%AF%87/" rel="prev" title="如何编写OptiFine光影包(工具篇)">
                  <i class="fa fa-chevron-left"></i> 如何编写OptiFine光影包(工具篇)
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/09/13/Minecraft%E6%B8%B2%E6%9F%93%E5%8E%9F%E7%90%86-%E5%BA%8F/" rel="next" title="Minecraft渲染原理(序)">
                  Minecraft渲染原理(序) <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HamiltonHuaji</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/HamiltonHuaji" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
