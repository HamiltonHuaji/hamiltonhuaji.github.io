<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">
    <script src="./des.js"></script>
    <script>
        var Status = {
            get available() { return 0; },
            get unavailable() { return 1; },
            get broken() { return 2; },
            get unknown() { return 3; }
        };
        class LaundryInfo {
            constructor(devid, notify) {
                this.devid = devid;
                this.notify = notify;
                this._status = Status.unknown;
                this.data = {};
                this.element = document.createElement("tr");
                document.querySelector("#overview tbody").appendChild(this.element);
            }
            set_status(newstatus) {
                if (newstatus < this._status) {
                    this._status = newstatus;
                    this.notify(this);
                }
                this._status = newstatus;
                console.log(this.devid, this._status, this.data.data.statusName);
            }
            update(data) {
                this.data = data;
                if (this.data.data.statusName === "空闲") {
                    this.set_status(Status.available);
                } else if (this.data.data.statusName === "使用中") {
                    this.set_status(Status.unavailable);
                } else if (this.data.data.statusName === "故障") {
                    this.set_status(Status.broken);
                } else {
                    this.set_status(Status.unknown);
                }
                this.element.innerHTML = `<td>${this.data.data.location}</td>
                    <td>${this.data.data.statusName}</td>
                    <td>${this.data.data.timeRemaining}</td>`;
            }
            check() {
                var url = `http://www.saywash.com/saywash/WashCallApi/common/laundry/getDeviceInfo.api?deviceQRCode=${this.devid}&ssid=${getTime()}&_=${(new Date()).valueOf()}`;
                var cors = `https://cors-anywhere.herokuapp.com/${url}`;
                $.getJSON(cors, (data) => { this.update(data); });
            }
        }
        function do_notify(entity) {
            var notification = new Notification(`${entity.data.data.location}的洗衣机已经可以使用`, {
                icon: `https://api.zsq.im/qrcode/?margin=2&text=http://uhome.haier.net/download/app/washcall/index.html?devid=${entity.devid}`,
                body: "扫描二维码可预定"
            });
            notification.onclick = function (event) {
                window.open(`https://api.zsq.im/qrcode/?margin=2&text=http://uhome.haier.net/download/app/washcall/index.html?devid=${entity.devid}`, '_blank');
            };
        }
        function notify(entity) {
            if (entity._status === Status.available) {
                console.log("signal");
                if (!("Notification" in window)) {
                    alert("This browser does not support desktop notification, try FireFox ?");
                }
                else if (Notification.permission === "granted") {
                    do_notify(entity);
                } else {
                    Notification.requestPermission(function (permission) {
                        if (permission === "granted") { do_notify(entity); }
                    });
                }
            }
        }
        devs = [
            "BL1510240019",
            "BL1610150017",
            "BL1510200077",
            "BL1510250100",
            "BL1510230004",
            "BLA1608280774"
        ];
        document.addEventListener("DOMContentLoaded", () => {
            ls = devs.map((d) => { return new LaundryInfo(d, notify); });
            function check() {
                ls.forEach(element => {
                    element.check();
                });
            }
            check();
            setInterval(check, 60000);
        });
    </script>
</head>

<body>
    <div class="navbar navbar-expand-md navbar-light bg-light mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                洗衣机预约系统
            </a>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <main class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        Overview
                    </div>
                    <div class="card-body">
                        <table id="overview" class="table">
                            <thead>
                                <tr>
                                    <td>位置</td>
                                    <td>状态</td>
                                    <td>剩余时间</td>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
</body>

</html>
