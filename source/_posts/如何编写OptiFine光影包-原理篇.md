---
title: 如何编写OptiFine光影包(原理篇)
date: 2022-03-03 23:48:03
tags:
- Computer Graphics
- Shaderpack
---

本文将首先简要回顾蒙特卡洛光线追踪算法，随后结合OptiFine的工作过程，对该算法在光影包中的实现难点进行分析，最后对主流光线追踪光影包的实现原理进行解释。

## 蒙特卡洛光线追踪

1986年，Kajiya等人提出了渲染方程，描述几何光学近似下光在空间中的传播过程
// TODO
作为一个积分方程，该方程一般不具有封闭形式的解，因此需要通过蒙特卡洛方法，求得一个随机变量 L ，使其期望为方程的解或近似解。

考虑该积分方程的一个近似，即光线在场景中反射N+1次后就会消失，因此方程的解可以被写为2N维的积分。设场景全部表面为Sigma，积分区间就是Sigma^N。这样的高维积分正是蒙特卡洛方法所擅长的。
// TODO：回顾蒙卡方法
而蒙特卡洛方法在求解如上积分时的每一个采样点，都等价于N条首尾相连的路径。除路径之总和的头端在光源上、尾端在摄像机上以外，每条路径的两端都在场景中的能反射光的表面上。因此沿着这些路径求取该采样点对结果的贡献的过程，就像追踪一条假想的光线路径一样。这就是蒙特卡洛光线追踪名称的含义。

## OptiFine的工作过程

此处我们不讨论OptiFine是如何对minecraft进行逻辑注入的，而着眼于它组织各着色器、并提供给着色器必要的输入的方式。

// To be continued...
